# ISHOCON3 マニュアル

このドキュメントでは、ISHOCON3の参考実装のアプリケーションの起動方法、ベンチマークの実行方法、サーバーコンフィグレーションなど、競技に関する具体的な事柄について説明します。


## アプリケーションの実行

どの言語の参考実装を使用するかで、アプリケーションの起動方法が異なります。

Python実装の起動:

```
$ cd ~/webapp/python
$ uv run gunicorn -c gunicorn.conf.py --bind "0.0.0.0:8080"
```

Ruby実装の起動:

```
$ cd ~/webapp/ruby
$ bundle exec puma -b tcp://0.0.0.0:8080
```


## ベンチマークの実行

ルートディレクトリに `benchmark` という実行ファイルがあり、これを使用することでベンチマークの実行が可能です。

```
$ cd ~/
$ ./benchmark
```

ベンチマークは4段階のログレベルが設定可能で、`--log-level` オプションで指定できます。

```
$ ./benchmark --log-level info
```

有効な値は `debug`, `info`, `warn`, `error` で、デフォルトは `info` です。
* `debug`: ベンチマークからのすべてのリクエストやユーザの行動を出力したい場合
* `info`: ユーザの行動やイベントを出力したい場合
* `warn`: スコアが伸びない原因となりうる警告メッセージのみ出力したい場合
* `error`: エラーメッセージのみ出力したい場合


特定のユーザや管理者の挙動をトレースしたい場合は、以下のように取得することができます。

```
$ ./benchmark --log-level debug > debug.log 2>&1
$ cat debug.log | grep "user=user12345"
$ cat debug.log | grep "user=admin"
```

また、`--target` オプションでベンチマーク実行先のURLを指定することができます。デフォルトでは `http://127.0.0.1:8080` で、下で説明するNginxを介さずにアプリケーションに直接アクセスするようになっています。



### ベンチマーク実行の流れ

負荷走行は以下のように実施されます。

1. `POST /api/initialize`（10秒でタイムアウト）
1. 負荷テストとアプリケーション整合性チェック（60秒）
1. 最終チェック（数秒～数十秒）

初期化処理もしくはアプリケーション整合性チェックに失敗すると、負荷走行は即時失敗になります。

負荷テスト終了時点でHTTPレスポンスの処理を打ち切ります。未完了のリクエストなどは強制的に切断されます。負荷テスト終了以降に強制的に切断されたリクエストはスコア、検証には影響しません。


### タイムアウト

ベンチマークからのリクエストのタイムアウトはそれぞれ以下のように設定されています。

| リクエスト | タイムアウト |
|------------|--------------|
| GET /api/admin/stats | 2秒 |
| GET /api/admin/train_sales | 2秒 |
| それ以外のリクエスト | 10秒 |


### ベンチマークの打ち切り

ベンチマークの実行は以下の状況で即時打ち切られます。打ち切られた場合はその時点でのスコアが最終スコアとなります。

* 初期化処理の実行中にエラーまたはタイムアウトが発生する
* 管理者の行動に関連するAPIのレスポンスがタイムアウトする
* 管理者の行動に関連するAPIがエラーを返す
* アプリケーション整合性チェックに失敗する


### 猶予時間

`GET /api/admin/stats` と `GET /api/admin/train_sales` で返される売上データの反映は1秒間の遅延が許容されます。つまり、これらのAPIで返されるデータは最大1秒前のデータであっても正しいとみなされます。

値が正しくない場合はアプリケーション整合性チェックに違反し、ベンチマークは失敗となります。


## サーバーコンフィグレーション

サーバーのスペックは以下の通りです。

- **Instance Type**: c7i.xlarge (4 vCPU, 8 GB Mem)
- **Volume**: 8GB, General Purpose SSD (gp3)

### MySQL

MySQL (8.0) が 3306 ポートで動作しています。初期ユーザーは以下の通りです。

- Username: `root`, Password: `ishocon`
- Username: `ishocon`, Password: `ishocon`

必要に応じて異なるMySQLバージョンに切り替えることや別のデータベースを使用することも可能です。

`~/webapp/sql/init.sh` を実行することで、データベースの初期化が可能です。これは `POST /api/initialize` が実行しているものと同じ処理です。

インデックスの追加やスキーマの変更を行う場合は既存の `*.sql` ファイルを変更するか、新たにSQLファイルを作成して `init.sh` に追加することをおすすめします。

### Nginx

Nginx (1.24) が 80 ポートで動作しています。必要に応じて設定を変更することも可能です。

`~/webapp/public/*` に静的ファイルが配置されており、ブラウザからサイトにアクセスする場合にはこれらのファイルが読み込まれAPIの動作確認をすることができます。

競技の対象はバックエンドのAPIのみで、これらの静的ファイルは変更してはいけません。
また、ベンチマークはこれらの静的ファイルにはアクセスしません。

### Payment App

決済サービスは `~/payment_app` に実行ファイルが配置されており、systemd サービスとして 8081 ポートで動作しています。

```
sudo systemctl status payment_app
```

決済サービスはユーザの決済時にアプリケーションからアクセスされ、ユーザの与信情報をもとに、決済の成功失敗を返します。

`POST /initialize` のエンドポイントで決済サービスのデータ初期化が行われ、参考実装ではアプリケーションの `POST /api/initialize` からこのエンドポイントが呼び出されます。

このサービスは最適化の対象外で、変更を加えることはできません。
