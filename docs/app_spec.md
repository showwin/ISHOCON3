## チケット予約時の行動

チケット購入者はその日の予定を持っていて、2-5区間を移動します。これを旅程と呼びます。
```
A -> C -> 2時間休憩 -> C -> B -> 4時間休憩 -> B -> E
```
例えばこのような旅程が考えられます。この例では3区間を移動しています。
ユーザがサイトを訪問したとき `/api/schedules` で返される列車一覧から旅程を満たすチケットを時間が早い順に購入します。

例えば現在時刻が20時だとすると、
A駅を20:00以降に発車する最も早い時間の列車を予約します。その列車がA駅20:30発、C駅20:50着だったとすると、
次にC駅を22:50以降に出発する列車を探して予約、購入します。その列車がC駅23:30発、B駅23:40着だったとすると、
そこから4時間休憩すると24時を過ぎてしまうので、最後の区間のB->Eのチケットは購入しません。

このように旅程に対して各区間でもっとも早い列車を選択、購入していきます。
旅程が24時を過ぎてしまう場合、または取得した列車一覧に条件を満たすものがない場合はその時点で購入を停止します。
最も早い列車が満席で売り切れている場合は次の列車の購入を試みます。

同じユーザが再度ログインしてくることもありますが、その場合には前回とは異なる新たな旅程を持ってチケットを購入しようとします。

購入枚数については、個人旅行客、家族を代表して購入する客、団体旅行のガイドなど多様なユーザがいるため、1枚から50枚(1車両の最大収容人数)となります。


## チケット購入時の行動

予約リクエストをした条件と合致する条件で席が確保できた場合、ユーザはそのチケットを購入します。
一方で列車一覧では席があると表示されていたのに、実際に予約までの間に席が埋まってしまってその列車の席を確保できない場合はレコメンドされた席を購入します。
しかしレコメンドされた場合には80%の確率で購入します。残りの20%の確率で購入をキャンセルし、それ以降の旅程の購入も諦めます。

各ユーザは事前に決められた額の与信を持っており、それを超えた金額を購入しようとすると決済システムからエラーが返ってきます。



## 入場について

列車出発の1時間前になると入場が可能になり、ユーザはその時間をすぎると入場し、`/api/entry` にリクエストが飛びます。
改札口ではQRコードをかざす必要があるため、入場前にQRコードの画像にリクエストが飛びます。

チケット購入時点ですでに1時間前を過ぎている場合も即時同様の行動を取ります。

入場するとそのチケットは `確定売上` となります。入場するまでは返金される可能性があるため、`未確定売上` として計上されます。
これは管理者向けのダッシュボードからも確認できます。


## 返金機能について

このサービスが契約している支払いサービスには返金機能がついていません。そのためユーザが返金してきた場合は当サービスがその返金分を負担する必要があり、返金はできるだけ避けなければいけません。(スコア計算でも返金分が減点されます)

ユーザが返金するのは、チケットの予約、購入後にすぐに改札口に向かったがすでに列車が発車していた場合のみです。
おもに以下の改善をすることで返金を防ぐことができます。

* 出発時刻が現在時刻に近すぎる列車は列車一覧 (`/api/scheduled`のレスポンス) に含めない
* 予約から入場までの一連の流れで使われるAPIを高速化する

ベンチマークがアプリケーションの動作確認のためにバリデーションのプロセスで意図的に返金をするため、ベンチマーク実行終了後に返金額がゼロになることはありません。


## 管理者の行動

管理者は3秒ごと(アプリケーション内時間30分毎)にダッシュボードで `累計売上` (確定売上の合計) と累計返金を確認し、十分に利益が出ていることを確認すると新たな車両とその車両の運行計画を投入します。

すべての新しい車両は既存の車両モデル(train_models)に紐づいており、新たな車両モデルの車両の投入はありません。
