<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新幹線チケット予約 - Ishokansen Reservation</title>
  <!-- Bootstrap v5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body class="bg-light">
  <!-- ヘッダー (ナビゲーションバー) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <!-- ブランド部分 -->
      <a class="navbar-brand d-flex align-items-center" href="#">
        <span class="fs-5 fw-bold">Ishokansen Reservation</span>
        <span class="ms-2 text-white-50" style="font-size: 0.9rem;">新幹線チケット予約</span>
      </a>
      <div class="d-flex ms-auto align-items-center">
        <span id="current-time-display" class="text-white me-3">--:--</span>
        <span id="initialize-button-container" class="me-3"></span>
        <span class="text-white me-3">Taro</span>
        <button id="logout-button" class="btn btn-outline-light btn-sm me-3">ログアウト</button>
        <button id="language-toggle" class="btn btn-outline-light btn-sm">EN</button>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <section id="reservation-section" class="mb-5">
      <h2 class="mb-3">予約フォーム</h2>
      <form id="reservation-form" class="row g-3">
        <div class="col-md-3">
          <label for="schedule-select" class="form-label">列車名</label>
          <select id="schedule-select" class="form-select"></select>
        </div>
        <div class="col-md-3">
          <label for="from-station-select" class="form-label">乗車駅</label>
          <select id="from-station-select" class="form-select"></select>
        </div>
        <div class="col-md-3">
          <label for="to-station-select" class="form-label">降車駅</label>
          <select id="to-station-select" class="form-select"></select>
        </div>
        <div class="col-md-1">
          <label for="num-people" class="form-label">人数</label>
          <input type="number" id="num-people" class="form-control" min="1" value="1"/>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="button" id="reserve-button" class="btn btn-primary w-100">予約</button>
        </div>
      </form>
    </section>

    <section id="schedule-list-section" class="mb-5">
      <h2 class="mb-3">チケット販売中の列車一覧</h2>
      <table id="schedule-list-table" class="table table-striped table-bordered table-responsive mb-4">
        <thead class="table-light">
          <tr>
            <th rowspan="2" class="align-middle">列車名</th>
            <th colspan="4" class="text-center">往路</th>
            <th colspan="4" class="text-center">復路</th>
          </tr>
          <tr>
            <th>A <i class="bi bi-arrow-right"></i> B</th>
            <th>B <i class="bi bi-arrow-right"></i> C</th>
            <th>C <i class="bi bi-arrow-right"></i> D</th>
            <th>D <i class="bi bi-arrow-right"></i> E</th>
            <th>E <i class="bi bi-arrow-right"></i> D</th>
            <th>D <i class="bi bi-arrow-right"></i> C</th>
            <th>C <i class="bi bi-arrow-right"></i> B</th>
            <th>B <i class="bi bi-arrow-right"></i> A</th>
          </tr>
        </thead>
        <tbody id="schedule-list-tbody"></tbody>
      </table>
    </section>

    <section id="purchased-tickets-section">
      <h2 class="mb-3">購入済チケット一覧</h2>
      <table id="purchased-tickets-table" class="table table-striped table-bordered table-responsive">
        <thead class="table-light">
          <tr>
            <th>列車名</th>
            <th>乗車駅</th>
            <th>降車駅</th>
            <th>出発時間</th>
            <th>人数</th>
            <th>金額</th>
            <th>入場済み</th>
            <th>返金</th>
            <th>入場</th>
          </tr>
        </thead>
        <tbody id="purchased-tickets-tbody">
        </tbody>
      </table>
    </section>
  </div>

  <!-- 予約結果モーダル -->
  <div class="modal fade" id="reservation-modal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reservationModalLabel">予約結果</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body" id="reservation-modal-body"></div>
        <div class="modal-footer" id="reservation-modal-footer"></div>
      </div>
    </div>
  </div>

  <!-- 入場モーダル -->
  <div class="modal fade" id="entrance-modal" tabindex="-1" aria-labelledby="entranceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="entranceModalLabel">入場確認</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body" id="entrance-modal-body"></div>
        <div class="modal-footer" id="entrance-modal-footer"></div>
      </div>
    </div>
  </div>

  <!-- モーダル（エントリ用＆返金確認用） -->
  <div class="modal fade" id="entrance-modal" tabindex="-1" aria-labelledby="entranceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="entranceModalLabel">入場確認</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body" id="entrance-modal-body"></div>
        <div class="modal-footer" id="entrance-modal-footer"></div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // i18n translations
    const translations = {
      ja: {
        pageTitle: "新幹線チケット予約",
        logout: "ログアウト",
        reservationForm: "予約フォーム",
        trainName: "列車名",
        boardingStation: "乗車駅",
        alightingStation: "降車駅",
        numPeople: "人数",
        reserve: "予約",
        ticketList: "チケット販売中の列車一覧",
        outbound: "往路",
        return: "復路",
        purchasedTickets: "購入済チケット一覧",
        departureTime: "出発時間",
        amount: "金額",
        entered: "入場済み",
        refund: "返金",
        entry: "入場",
        reservationResult: "予約結果",
        close: "閉じる",
        cancel: "キャンセル",
        purchase: "購入",
        ok: "OK",
        entryConfirmation: "入場確認",
        enterGate: "入場する",
        initialize: "初期化",
        messages: {
          success: "以下の座席を確保しました:",
          recommend: "指定の条件では席が確保できませんでした。代わりにこちらはいかがですか？",
          fail: {
            NO_SEAT_AVAILABLE: "指定の条件に当てはまるチケットはご用意できませんでした"
          },
          discounted: "(離れた席のため半額)",
          scheduleInfo: "列車名:",
          section: "区間:",
          seats: "座席:",
          totalPrice: "合計金額:",
          yen: "円",
          refundConfirm: "このチケットを返金しますか？",
          trainDeparted: "列車の出発時間をすでに過ぎております。返金しますか？",
          sameStationError: "乗車駅と降車駅が同じです。異なる駅を選択してください。",
          noTrainSelectedError: "列車を選択してください。"
        }
      },
      en: {
        pageTitle: "Bullet Train Ticket Reservation",
        logout: "Logout",
        reservationForm: "Reservation Form",
        trainName: "Train",
        boardingStation: "From",
        alightingStation: "To",
        numPeople: "People",
        reserve: "Reserve",
        ticketList: "Available Trains",
        outbound: "Outbound",
        return: "Return",
        purchasedTickets: "Purchased Tickets",
        departureTime: "Departure",
        amount: "Amount",
        entered: "Entered",
        refund: "Refund",
        entry: "Entry",
        reservationResult: "Reservation Result",
        close: "Close",
        cancel: "Cancel",
        purchase: "Purchase",
        ok: "OK",
        entryConfirmation: "Entry Confirmation",
        enterGate: "Enter",
        initialize: "Initialize",
        messages: {
          success: "The following seats have been reserved:",
          recommend: "Seats with the specified conditions could not be secured. How about this alternative?",
          fail: {
            NO_SEAT_AVAILABLE: "No tickets are available for the specified conditions"
          },
          discounted: "(50% off for separated seats)",
          scheduleInfo: "Train:",
          section: "Section:",
          seats: "Seats:",
          totalPrice: "Total:",
          yen: "JPY",
          refundConfirm: "Do you want to refund this ticket?",
          trainDeparted: "The train has already departed. Do you want a refund?",
          sameStationError: "Boarding and alighting stations are the same. Please select different stations.",
          noTrainSelectedError: "Please select a train."
        }
      }
    };

    let currentLang = 'ja';

    function t(key) {
      const keys = key.split('.');
      let value = translations[currentLang];
      for (const k of keys) {
        value = value?.[k];
      }
      return value || key;
    }

    function updateUILanguage() {
      // Update page title
      document.title = t('pageTitle') + " - Ishokansen Reservation";

      // Update header subtitle
      document.querySelector('.navbar-brand .text-white-50').textContent = t('pageTitle');

      // Update logout button
      document.getElementById('logout-button').textContent = t('logout');

      // Update language toggle button
      document.getElementById('language-toggle').textContent = currentLang === 'ja' ? 'EN' : 'JP';

      // Update reservation form section
      document.querySelector('#reservation-section h2').textContent = t('reservationForm');
      document.querySelector('label[for="schedule-select"]').textContent = t('trainName');
      document.querySelector('label[for="from-station-select"]').textContent = t('boardingStation');
      document.querySelector('label[for="to-station-select"]').textContent = t('alightingStation');
      document.querySelector('label[for="num-people"]').textContent = t('numPeople');
      document.getElementById('reserve-button').textContent = t('reserve');

      // Update schedule list section
      document.querySelector('#schedule-list-section h2').textContent = t('ticketList');
      const headers = document.querySelectorAll('#schedule-list-table thead tr');
      if (headers[0]) {
        const thList = headers[0].querySelectorAll('th');
        if (thList[0]) thList[0].textContent = t('trainName');
        if (thList[1]) thList[1].textContent = t('outbound');
        if (thList[2]) thList[2].textContent = t('return');
      }

      // Update purchased tickets section
      document.querySelector('#purchased-tickets-section h2').textContent = t('purchasedTickets');
      const purchasedHeaders = document.querySelectorAll('#purchased-tickets-table thead th');
      if (purchasedHeaders[0]) purchasedHeaders[0].textContent = t('trainName');
      if (purchasedHeaders[1]) purchasedHeaders[1].textContent = t('boardingStation');
      if (purchasedHeaders[2]) purchasedHeaders[2].textContent = t('alightingStation');
      if (purchasedHeaders[3]) purchasedHeaders[3].textContent = t('departureTime');
      if (purchasedHeaders[4]) purchasedHeaders[4].textContent = t('numPeople');
      if (purchasedHeaders[5]) purchasedHeaders[5].textContent = t('amount');
      if (purchasedHeaders[6]) purchasedHeaders[6].textContent = t('entered');
      if (purchasedHeaders[7]) purchasedHeaders[7].textContent = t('refund');
      if (purchasedHeaders[8]) purchasedHeaders[8].textContent = t('entry');

      // Update modal titles
      document.getElementById('reservationModalLabel').textContent = t('reservationResult');
      document.getElementById('entranceModalLabel').textContent = t('entryConfirmation');

      // Re-render purchased tickets to update button text
      renderPurchasedTickets();

      // Update initialize button if it exists
      const initBtn = document.querySelector('#initialize-button-container button');
      if (initBtn) {
        initBtn.textContent = t('initialize');
      }
    }

    async function fetchSchedules() {
      const res = await fetch('/api/schedules');
      const data = await res.json();
      return data.schedules;
    }

    async function fetchStations() {
      const res = await fetch('/api/stations');
      const data = await res.json();
      return data.stations;
    }

    async function fetchCurrentTime() {
      const res = await fetch('/api/current_time');
      const data = await res.json();
      return data.current_time;
    }

    async function fetchPurchasedTickets() {
      const res = await fetch('/api/purchased_tickets');
      if (!res.ok) {
        location.href = '/login.html';
        return [];
      }
      const data = await res.json();
      return data.tickets;
    }

    let schedules = [];
    let stations = [];
    let currentHours = 0;
    let currentMinutes = 0;
    let clockInterval = null;
    let purchasedTickets = [];

    const scheduleSelect = document.getElementById('schedule-select');
    const fromStationSelect = document.getElementById('from-station-select');
    const toStationSelect = document.getElementById('to-station-select');
    const scheduleListTbody = document.getElementById('schedule-list-tbody');
    const reserveButton = document.getElementById('reserve-button');
    const numPeopleInput = document.getElementById('num-people');
    const currentTimeDisplay = document.getElementById('current-time-display');
    const purchasedTicketsTbody = document.getElementById('purchased-tickets-tbody');
    const reservationModal = new bootstrap.Modal(document.getElementById('reservation-modal'), {});
    const entranceModal = new bootstrap.Modal(document.getElementById('entrance-modal'), {});
    const initializeButtonContainer = document.getElementById('initialize-button-container');

    const segmentMap = [
      { key: 'Arena->Bridge', from: 'A', to: 'B' },
      { key: 'Bridge->Cave', from: 'B', to: 'C' },
      { key: 'Cave->Dock', from: 'C', to: 'D' },
      { key: 'Dock->Edge', from: 'D', to: 'E' },
      { key: 'Edge->Dock', from: 'E', to: 'D' },
      { key: 'Dock->Cave', from: 'D', to: 'C' },
      { key: 'Cave->Bridge', from: 'C', to: 'B' },
      { key: 'Bridge->Arena', from: 'B', to: 'A' }
    ];

    const availabilityIcons = {
      none: '✗',
      few: '△',
      lots: '◯'
    };

    async function init() {
      const [fetchedSchedules, fetchedStations, fetchedCurrentTime, fetchedTickets] = await Promise.all([
        fetchSchedules(), fetchStations(), fetchCurrentTime(), fetchPurchasedTickets()
      ]);

      schedules = fetchedSchedules;
      stations = fetchedStations;
      purchasedTickets = fetchedTickets;

      const [h, m] = fetchedCurrentTime.split(':').map(v => parseInt(v,10));
      currentHours = h;
      currentMinutes = m;

      renderSchedules(schedules);
      renderScheduleOptions(schedules);
      renderStationOptions(stations, fromStationSelect, 0);
      renderStationOptions(stations, toStationSelect, 1);

      renderPurchasedTickets();

      updateCurrentTimeDisplay();
      startClockSimulation();
      updateUILanguage();

      // 定期的に列車(スケジュール)一覧を更新
      var updatedSchedules
      setInterval(async () => {
        lastData = structuredClone(updatedSchedules);
        updatedSchedules = await fetchSchedules();
        if (JSON.stringify(lastData) !== JSON.stringify(updatedSchedules)) {
          renderSchedules(updatedSchedules);
          renderScheduleOptions(updatedSchedules);
        }
      }, 1000);

      // セッションチェックを開始
      checkSession();
    }

    function renderSchedules(scheduleData) {
      scheduleListTbody.innerHTML = '';

      scheduleData.forEach(t => {
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.textContent = t.id;
        tr.appendChild(tdName);

        segmentMap.forEach(seg => {
          const td = document.createElement('td');
          const status = t.availability[seg.key] || 'none';
          const icon = availabilityIcons[status] || '✗';

          const departure = t.departure_at && t.departure_at[seg.key] ? t.departure_at[seg.key] : '--:--';
          td.textContent = `${icon} (${departure})`;

          tr.appendChild(td);
        });

        scheduleListTbody.appendChild(tr);
      });
    }

    function renderScheduleOptions(scheduleData) {
      scheduleSelect.innerHTML = '';
      scheduleData.forEach(t => {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = t.id;
        scheduleSelect.appendChild(option);
      });
    }

    function renderStationOptions(stationData, selectEl, defaultIndex = 0) {
      selectEl.innerHTML = '';
      stationData.forEach((s, index) => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = s.name;
        if (index === defaultIndex) {
          option.selected = true;
        }
        selectEl.appendChild(option);
      });
    }

    reserveButton.addEventListener('click', async () => {
      const selectedScheduleId = scheduleSelect.value;
      const fromStationId = fromStationSelect.value;
      const toStationId = toStationSelect.value;
      const numPeople = parseInt(numPeopleInput.value, 10);

      // Validate that a train is selected
      if (!selectedScheduleId || selectedScheduleId.trim() === '') {
        showErrorModal(t('messages.noTrainSelectedError'));
        return;
      }

      // Validate that from and to stations are different
      if (fromStationId === toStationId) {
        showErrorModal(t('messages.sameStationError'));
        return;
      }

      const res = await fetch('/api/reserve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          schedule_id: selectedScheduleId,
          from_station_id: fromStationId,
          to_station_id: toStationId,
          num_people: numPeople
        })
      }).then(r=>r.json());

      handleReservationResponse(res);
    });

    function showErrorModal(errorMessage) {
      const modalBody = document.getElementById('reservation-modal-body');
      const modalFooter = document.getElementById('reservation-modal-footer');
      modalBody.innerHTML = '';
      modalFooter.innerHTML = '';

      modalBody.innerHTML = `<p class="text-danger">${errorMessage}</p>`;

      const okBtn = document.createElement('button');
      okBtn.className = 'btn btn-primary';
      okBtn.textContent = t('ok');
      okBtn.setAttribute('data-bs-dismiss','modal');
      modalFooter.appendChild(okBtn);

      reservationModal.show();
    }

    function handleReservationResponse(res) {
      const modalBody = document.getElementById('reservation-modal-body');
      const modalFooter = document.getElementById('reservation-modal-footer');
      modalBody.innerHTML = '';
      modalFooter.innerHTML = '';

      if (res.status === 'success' || res.status === 'recommend') {
        const info = res.status === 'success' ? res.reserved : res.recommend;
        const discountMessage = info.is_discounted ? t('messages.discounted') : '';

        modalBody.innerHTML = `
          <p>${res.status === 'success' ? t('messages.success') : t('messages.recommend')}</p>
          <p>${t('messages.scheduleInfo')} ${info.schedule_id}</p>
          <p>${t('messages.section')} ${info.from_station} -> ${info.to_station}</p>
          <p>${t('departureTime')}: ${info.departure_at}</p>
          <p>${t('messages.seats')} ${info.seats.join(', ')}</p>
          <p>${t('messages.totalPrice')} ${info.total_price}${t('messages.yen')} ${discountMessage}</p>
          <div id="purchase-error-msg" class="text-danger mt-2"></div>
        `;
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-secondary';
        cancelBtn.textContent = t('cancel');
        cancelBtn.setAttribute('data-bs-dismiss','modal');

        const purchaseBtn = document.createElement('button');
        purchaseBtn.className = 'btn btn-primary';
        purchaseBtn.textContent = t('purchase');
        purchaseBtn.addEventListener('click', async () => {
          purchaseBtn.disabled = true;
          await purchaseTicketAPI(info);
        });

        modalFooter.appendChild(cancelBtn);
        modalFooter.appendChild(purchaseBtn);
      } else {
        // fail
        const ec = res.error_code || 'UNKNOWN';
        const msg = t('messages.fail.' + ec) || t('messages.fail.NO_SEAT_AVAILABLE');
        modalBody.innerHTML = `<p>${msg}</p>`;
        const okBtn = document.createElement('button');
        okBtn.className = 'btn btn-primary';
        okBtn.textContent = t('ok');
        okBtn.setAttribute('data-bs-dismiss','modal');
        modalFooter.appendChild(okBtn);
      }

      reservationModal.show();
    }

    async function purchaseTicketAPI(info) {
      const purchaseRes = await fetch('/api/purchase', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          reservation_id: info.reservation_id
        })
      }).then(r=>r.json());

      if (purchaseRes.status === 'success') {
        purchasedTickets.push({
          schedule_id: info.schedule_id,
          from_station: info.from_station,
          to_station: info.to_station,
          departure_at: info.departure_at,
          seats: info.seats,
          total_price: info.total_price,
          is_entered: false,
          reservation_id: info.reservation_id,
          entry_token: purchaseRes.entry_token,
          qr_code_url: purchaseRes.qr_code_url
        });
        renderPurchasedTickets();
        reservationModal.hide();
      } else {
        const errorMsgEl = document.getElementById('purchase-error-msg');
        errorMsgEl.textContent = purchaseRes.message;
      }
    }

    function renderPurchasedTickets() {
      purchasedTicketsTbody.innerHTML = '';
      purchasedTickets.forEach((ticket, index) => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${ticket.schedule_id}</td>
          <td>${ticket.from_station}</td>
          <td>${ticket.to_station}</td>
          <td>${ticket.departure_at}</td>
          <td>${ticket.seats.length}</td>
          <td>${ticket.total_price}</td>
        `;

        const tdEntered = document.createElement('td');
        const enteredCheckbox = document.createElement('input');
        enteredCheckbox.type = 'checkbox';
        enteredCheckbox.checked = ticket.is_entered;
        enteredCheckbox.disabled = true;
        tdEntered.appendChild(enteredCheckbox);
        tr.appendChild(tdEntered);

        const tdRefund = document.createElement('td');
        const refundBtn = document.createElement('button');
        refundBtn.className = 'btn btn-danger btn-sm';
        refundBtn.textContent = t('refund');
        refundBtn.disabled = ticket.is_entered;
        refundBtn.addEventListener('click', () => {
          showRefundModal(ticket, index, t('messages.refundConfirm'));
        });
        tdRefund.appendChild(refundBtn);
        tr.appendChild(tdRefund);

        const tdEntrance = document.createElement('td');
        const entranceBtn = document.createElement('button');
        entranceBtn.className = 'btn btn-success btn-sm';
        entranceBtn.textContent = t('entry');
        entranceBtn.disabled = ticket.is_entered;
        entranceBtn.addEventListener('click', () => {
          showEntryModal(ticket, index);
        });
        tdEntrance.appendChild(entranceBtn);
        tr.appendChild(tdEntrance);

        purchasedTicketsTbody.appendChild(tr);
      });
    }

    function showEntryModal(ticket, ticketIndex) {
      const entranceModalBody = document.getElementById('entrance-modal-body');
      const entranceModalFooter = document.getElementById('entrance-modal-footer');
      entranceModalBody.innerHTML = '';
      entranceModalFooter.innerHTML = '';

      const imgWrapper = document.createElement('div');
      imgWrapper.className = 'd-flex justify-content-center';

      const img = document.createElement('img');
      img.src = ticket.qr_code_url;
      img.alt = 'Entry QR Code';
      img.style.maxWidth = '100%';
      imgWrapper.appendChild(img);
      entranceModalBody.appendChild(imgWrapper);

      const errorMsg = document.createElement('div');
      errorMsg.className = 'text-danger mt-2';
      entranceModalBody.appendChild(errorMsg);

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-secondary';
      cancelBtn.textContent = t('cancel');
      cancelBtn.setAttribute('data-bs-dismiss','modal');

      const enterBtn = document.createElement('button');
      enterBtn.className = 'btn btn-primary';
      enterBtn.textContent = t('enterGate');
      enterBtn.addEventListener('click', async () => {
        const enterRes = await fetch('/api/entry', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ entry_token: ticket.entry_token })
        }).then(r=>r.json());

        if (enterRes.status === 'success') {
          ticket.is_entered = true;
          renderPurchasedTickets();
          entranceModal.hide();
        } else if (enterRes.status === 'train_departed') {
          entranceModal.hide();
          // 続けてモーダルを表示できるように前のモーダルが消えたのを確認してから表示
          const handler = () => {
            entranceModal._element.removeEventListener('hidden.bs.modal', handler);
            showRefundModal(ticket, ticketIndex, t('messages.trainDeparted'));
          };
          entranceModal._element.addEventListener('hidden.bs.modal', handler);
        } else {
          errorMsg.textContent = t('messages.fail.NO_SEAT_AVAILABLE');
        }
      });

      entranceModalFooter.appendChild(cancelBtn);
      entranceModalFooter.appendChild(enterBtn);

      entranceModal.show();
    }

    // 入場処理でエラーになった場合にも使うrefundモーダル表示関数
    function showRefundModal(ticket, ticketIndex, message) {
      const entranceModalBody = document.getElementById('entrance-modal-body');
      const entranceModalFooter = document.getElementById('entrance-modal-footer');
      if(!entranceModalBody || !entranceModalFooter)return;

      entranceModalBody.innerHTML = `<p>${message}</p>`;
      entranceModalFooter.innerHTML = '';

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-secondary';
      cancelBtn.textContent = t('cancel');
      cancelBtn.setAttribute('data-bs-dismiss','modal');

      const refundBtn = document.createElement('button');
      refundBtn.className = 'btn btn-primary';
      refundBtn.textContent = t('refund');
      refundBtn.addEventListener('click', async () => {
        const res = await fetch('/api/refund', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ reservation_id: ticket.reservation_id })
        });
        if(res.ok) {
          // 返金成功後チケット削除
          purchasedTickets.splice(ticketIndex, 1);
          renderPurchasedTickets();
          entranceModal.hide();
        } else {
          // 返金失敗時の処理(必要なら)
          console.error('返金失敗');
        }
      });

      entranceModalFooter.appendChild(cancelBtn);
      entranceModalFooter.appendChild(refundBtn);

      entranceModal.show();
    }

    function showInitializeButton() {
      initializeButtonContainer.innerHTML = '';
      const btn = document.createElement('button');
      btn.className = 'btn btn-warning btn-sm';
      btn.textContent = t('initialize');
      btn.addEventListener('click', async () => {
        await fetch('/api/initialize', {method: 'POST'});
        location.reload();
      });
      initializeButtonContainer.appendChild(btn);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const logoutButton = document.getElementById('logout-button');
      logoutButton?.addEventListener('click', async () => {
        const res = await fetch('/api/logout', {
          method: 'POST'
        });
        if (res.ok) {
          // ログアウト成功時にログインページへ遷移
          location.href = '/login.html';
        } else {
          console.error('ログアウトに失敗しました');
          // 必要であればエラー表示など
        }
      });

      // Language toggle event listener
      const languageToggle = document.getElementById('language-toggle');
      languageToggle?.addEventListener('click', () => {
        currentLang = currentLang === 'ja' ? 'en' : 'ja';
        updateUILanguage();
      });
    });

    function updateCurrentTimeDisplay() {
      const hh = String(currentHours).padStart(2,'0');
      const mm = String(currentMinutes).padStart(2,'0');
      currentTimeDisplay.textContent = `${hh}:${mm}`;
    }

    function incrementTimeByOneMinute() {
      if (currentHours === 24 && currentMinutes === 0) {
        clearInterval(clockInterval);
        clockInterval = null;
        showInitializeButton();
        return;
      }

      currentMinutes += 1;
      if (currentMinutes >= 60) {
        currentMinutes = 0;
        currentHours += 1;
        if (currentHours > 24) {
          currentHours = 24;
          currentMinutes = 0;
        }
      }

      updateCurrentTimeDisplay();
    }

    async function checkSession() {
      try {
        const res = await fetch('/api/session');
        if (!res.ok) {
          console.error('セッションチェックのリクエストに失敗しました');
          return;
        }
        const data = await res.json();
        if (data.status === 'session_expired') {
          location.href = '/login.html';
        } else if (data.status === 'active') {
          setTimeout(checkSession, data.next_check);
        } else {
          console.error('未知のステータス: ', data.status);
        }
      } catch (err) {
        console.error('セッションチェックエラー: ', err);
      }
    }

    function startClockSimulation() {
      clockInterval = setInterval(incrementTimeByOneMinute, 100);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
