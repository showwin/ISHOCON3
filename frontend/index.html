<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新幹線チケット予約 - Ishokansen Reservation</title>
  <!-- Bootstrap v5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body class="bg-light">
  <!-- ヘッダー (ナビゲーションバー) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <!-- ブランド部分 -->
      <a class="navbar-brand d-flex align-items-center" href="#">
        <span class="fs-5 fw-bold">Ishokansen Reservation</span>
        <span class="ms-2 text-white-50" style="font-size: 0.9rem;">新幹線チケット予約</span>
      </a>
      <div class="d-flex ms-auto align-items-center">
        <span id="current-time-display" class="text-white me-3">--:--</span>
        <span id="initialize-button-container" class="me-3"></span>
        <span class="text-white me-3">Taro</span>
        <button id="logout-button" class="btn btn-outline-light btn-sm me-3">ログアウト</button>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <section id="reservation-section" class="mb-5">
      <h2 class="mb-3">予約フォーム</h2>
      <form id="reservation-form" class="row g-3">
        <div class="col-md-3">
          <label for="schedule-select" class="form-label">列車名</label>
          <select id="schedule-select" class="form-select"></select>
        </div>
        <div class="col-md-3">
          <label for="from-station-select" class="form-label">乗車駅</label>
          <select id="from-station-select" class="form-select"></select>
        </div>
        <div class="col-md-3">
          <label for="to-station-select" class="form-label">降車駅</label>
          <select id="to-station-select" class="form-select"></select>
        </div>
        <div class="col-md-2">
          <label for="num-people" class="form-label">人数</label>
          <input type="number" id="num-people" class="form-control" min="1" value="1"/>
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <button type="button" id="reserve-button" class="btn btn-primary w-100">予約</button>
        </div>
      </form>
    </section>

    <section id="schedule-list-section" class="mb-5">
      <h2 class="mb-3">チケット販売中の列車一覧</h2>
      <table id="schedule-list-table" class="table table-striped table-bordered table-responsive mb-4">
        <thead class="table-light">
          <tr>
            <th rowspan="2" class="align-middle">列車名</th>
            <th colspan="4" class="text-center">往路</th>
            <th colspan="4" class="text-center">復路</th>
          </tr>
          <tr>
            <th>A <i class="bi bi-arrow-right"></i> B</th>
            <th>B <i class="bi bi-arrow-right"></i> C</th>
            <th>C <i class="bi bi-arrow-right"></i> D</th>
            <th>D <i class="bi bi-arrow-right"></i> E</th>
            <th>E <i class="bi bi-arrow-right"></i> D</th>
            <th>D <i class="bi bi-arrow-right"></i> C</th>
            <th>C <i class="bi bi-arrow-right"></i> B</th>
            <th>B <i class="bi bi-arrow-right"></i> A</th>
          </tr>
        </thead>
        <tbody id="schedule-list-tbody"></tbody>
      </table>
    </section>

    <section id="purchased-tickets-section">
      <h2 class="mb-3">購入済チケット一覧</h2>
      <table id="purchased-tickets-table" class="table table-striped table-bordered table-responsive">
        <thead class="table-light">
          <tr>
            <th>列車名</th>
            <th>乗車駅</th>
            <th>降車駅</th>
            <th>出発時間</th>
            <th>人数</th>
            <th>金額</th>
            <th>入場済み</th>
            <th>返金</th>
            <th>入場</th>
          </tr>
        </thead>
        <tbody id="purchased-tickets-tbody">
        </tbody>
      </table>
    </section>
  </div>

  <!-- 予約結果モーダル -->
  <div class="modal fade" id="reservation-modal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reservationModalLabel">予約結果</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body" id="reservation-modal-body"></div>
        <div class="modal-footer" id="reservation-modal-footer"></div>
      </div>
    </div>
  </div>

  <!-- 入場モーダル -->
  <div class="modal fade" id="entrance-modal" tabindex="-1" aria-labelledby="entranceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="entranceModalLabel">入場確認</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body" id="entrance-modal-body"></div>
        <div class="modal-footer" id="entrance-modal-footer"></div>
      </div>
    </div>
  </div>

  <!-- モーダル（エントリ用＆返金確認用） -->
  <div class="modal fade" id="entrance-modal" tabindex="-1" aria-labelledby="entranceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="entranceModalLabel">入場確認</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body" id="entrance-modal-body"></div>
        <div class="modal-footer" id="entrance-modal-footer"></div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const messages = {
      success: "以下の座席を確保しました:",
      recommend: "指定の条件では席が確保できませんでした。代わりにこちらはいかがですか？",
      fail: {
        NO_SEAT_AVAILABLE: "指定の条件に当てはまるチケットはご用意できませんでした"
      }
    };

    async function fetchSchedules() {
      const res = await fetch('/api/schedules');
      const data = await res.json();
      return data.schedules;
    }

    async function fetchStations() {
      const res = await fetch('/api/stations');
      const data = await res.json();
      return data.stations;
    }

    async function fetchCurrentTime() {
      const res = await fetch('/api/current_time');
      const data = await res.json();
      return data.current_time;
    }

    async function fetchPurchasedTickets() {
      const res = await fetch('/api/purchased_tickets');
      const data = await res.json();
      return data.tickets;
    }

    let schedules = [];
    let stations = [];
    let currentHours = 0;
    let currentMinutes = 0;
    let clockInterval = null;
    let purchasedTickets = [];

    const scheduleSelect = document.getElementById('schedule-select');
    const fromStationSelect = document.getElementById('from-station-select');
    const toStationSelect = document.getElementById('to-station-select');
    const scheduleListTbody = document.getElementById('schedule-list-tbody');
    const reserveButton = document.getElementById('reserve-button');
    const numPeopleInput = document.getElementById('num-people');
    const currentTimeDisplay = document.getElementById('current-time-display');
    const purchasedTicketsTbody = document.getElementById('purchased-tickets-tbody');
    const reservationModal = new bootstrap.Modal(document.getElementById('reservation-modal'), {});
    const entranceModal = new bootstrap.Modal(document.getElementById('entrance-modal'), {});
    const initializeButtonContainer = document.getElementById('initialize-button-container');

    const segmentMap = [
      { key: 'Arena->Bridge', from: 'A', to: 'B' },
      { key: 'Bridge->Cave', from: 'B', to: 'C' },
      { key: 'Cave->Dock', from: 'C', to: 'D' },
      { key: 'Dock->Edge', from: 'D', to: 'E' },
      { key: 'Edge->Dock', from: 'E', to: 'D' },
      { key: 'Dock->Cave', from: 'D', to: 'C' },
      { key: 'Cave->Bridge', from: 'C', to: 'B' },
      { key: 'Bridge->Arena', from: 'B', to: 'A' }
    ];

    const availabilityIcons = {
      none: '✗',
      few: '△',
      lots: '◯'
    };

    async function init() {
      const [fetchedSchedules, fetchedStations, fetchedCurrentTime, fetchedTickets] = await Promise.all([
        fetchSchedules(), fetchStations(), fetchCurrentTime(), fetchPurchasedTickets()
      ]);

      schedules = fetchedSchedules;
      stations = fetchedStations;
      purchasedTickets = fetchedTickets;

      const [h, m] = fetchedCurrentTime.split(':').map(v => parseInt(v,10));
      currentHours = h;
      currentMinutes = m;

      renderSchedules(schedules);
      renderScheduleOptions(schedules);
      renderStationOptions(stations, fromStationSelect);
      renderStationOptions(stations, toStationSelect);

      renderPurchasedTickets();

      updateCurrentTimeDisplay();
      startClockSimulation();

      // 定期的に列車(スケジュール)一覧を更新
      var updatedSchedules
      setInterval(async () => {
        lastData = structuredClone(updatedSchedules);
        updatedSchedules = await fetchSchedules();
        if (JSON.stringify(lastData) !== JSON.stringify(updatedSchedules)) {
          renderSchedules(updatedSchedules);
          renderScheduleOptions(updatedSchedules);
        }
      }, 1000);

      // セッションチェックを開始
      checkSession();
    }

    function renderSchedules(scheduleData) {
      scheduleListTbody.innerHTML = '';

      scheduleData.forEach(t => {
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.textContent = t.id;
        tr.appendChild(tdName);

        segmentMap.forEach(seg => {
          const td = document.createElement('td');
          const status = t.availability[seg.key] || 'none';
          const icon = availabilityIcons[status] || '✗';

          const departure = t.departure_at && t.departure_at[seg.key] ? t.departure_at[seg.key] : '--:--';
          td.textContent = `${icon} (${departure})`;

          tr.appendChild(td);
        });

        scheduleListTbody.appendChild(tr);
      });
    }

    function renderScheduleOptions(scheduleData) {
      scheduleSelect.innerHTML = '';
      scheduleData.forEach(t => {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = t.id;
        scheduleSelect.appendChild(option);
      });
    }

    function renderStationOptions(stationData, selectEl) {
      selectEl.innerHTML = '';
      stationData.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = s.name;
        selectEl.appendChild(option);
      });
    }

    reserveButton.addEventListener('click', async () => {
      const selectedScheduleId = scheduleSelect.value;
      const fromStationId = fromStationSelect.value;
      const toStationId = toStationSelect.value;
      const numPeople = parseInt(numPeopleInput.value, 10);

      const res = await fetch('/api/reserve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          schedule_id: selectedScheduleId,
          from_station_id: fromStationId,
          to_station_id: toStationId,
          num_people: numPeople
        })
      }).then(r=>r.json());

      handleReservationResponse(res);
    });

    function handleReservationResponse(res) {
      const modalBody = document.getElementById('reservation-modal-body');
      const modalFooter = document.getElementById('reservation-modal-footer');
      modalBody.innerHTML = '';
      modalFooter.innerHTML = '';

      if (res.status === 'success' || res.status === 'recommend') {
        const info = res.status === 'success' ? res.reserved : res.recommend;
        const discountMessage = info.is_discounted ? `(離れた席のため半額)` : '';

        modalBody.innerHTML = `
          <p>${res.status === 'success' ? messages.success : messages.recommend}</p>
          <p>列車名: ${info.schedule_id}</p>
          <p>区間: ${info.from_station} -> ${info.to_station}</p>
          <p>出発時間: ${info.departure_at}</p>
          <p>座席: ${info.seats.join(', ')}</p>
          <p>合計金額: ${info.total_price}円 ${discountMessage}</p>
          <div id="purchase-error-msg" class="text-danger mt-2"></div>
        `;
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-secondary';
        cancelBtn.textContent = 'キャンセル';
        cancelBtn.setAttribute('data-bs-dismiss','modal');

        const purchaseBtn = document.createElement('button');
        purchaseBtn.className = 'btn btn-primary';
        purchaseBtn.textContent = '購入';
        purchaseBtn.addEventListener('click', async () => {
          purchaseBtn.disabled = true;
          await purchaseTicketAPI(info);
        });

        modalFooter.appendChild(cancelBtn);
        modalFooter.appendChild(purchaseBtn);
      } else {
        // fail
        const ec = res.error_code || 'UNKNOWN';
        const msg = messages.fail[ec] || 'エラーが発生しました';
        modalBody.innerHTML = `<p>${msg}</p>`;
        const okBtn = document.createElement('button');
        okBtn.className = 'btn btn-primary';
        okBtn.textContent = 'OK';
        okBtn.setAttribute('data-bs-dismiss','modal');
        modalFooter.appendChild(okBtn);
      }

      reservationModal.show();
    }

    async function purchaseTicketAPI(info) {
      const purchaseRes = await fetch('/api/purchase', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          reservation_id: info.reservation_id
        })
      }).then(r=>r.json());

      if (purchaseRes.status === 'success') {
        purchasedTickets.push({
          schedule_id: info.schedule_id,
          from_station: info.from_station,
          to_station: info.to_station,
          departure_at: info.departure_at,
          seats: info.seats,
          total_price: info.total_price,
          is_entered: false,
          reservation_id: info.reservation_id,
          entry_token: purchaseRes.entry_token,
          qr_code_url: purchaseRes.qr_code_url
        });
        renderPurchasedTickets();
        reservationModal.hide();
      } else {
        const errorMsgEl = document.getElementById('purchase-error-msg');
        errorMsgEl.textContent = purchaseRes.message;
      }
    }

    function renderPurchasedTickets() {
      purchasedTicketsTbody.innerHTML = '';
      purchasedTickets.forEach((ticket, index) => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${ticket.schedule_id}</td>
          <td>${ticket.from_station}</td>
          <td>${ticket.to_station}</td>
          <td>${ticket.departure_at}</td>
          <td>${ticket.seats.length}</td>
          <td>${ticket.total_price}</td>
        `;

        const tdEntered = document.createElement('td');
        const enteredCheckbox = document.createElement('input');
        enteredCheckbox.type = 'checkbox';
        enteredCheckbox.checked = ticket.is_entered;
        enteredCheckbox.disabled = true;
        tdEntered.appendChild(enteredCheckbox);
        tr.appendChild(tdEntered);

        const tdRefund = document.createElement('td');
        const refundBtn = document.createElement('button');
        refundBtn.className = 'btn btn-danger btn-sm';
        refundBtn.textContent = '返金';
        refundBtn.disabled = ticket.is_entered;
        refundBtn.addEventListener('click', () => {
          showRefundModal(ticket, index, "このチケットを返金しますか？");
        });
        tdRefund.appendChild(refundBtn);
        tr.appendChild(tdRefund);

        const tdEntrance = document.createElement('td');
        const entranceBtn = document.createElement('button');
        entranceBtn.className = 'btn btn-success btn-sm';
        entranceBtn.textContent = '入場';
        entranceBtn.disabled = ticket.is_entered;
        entranceBtn.addEventListener('click', () => {
          showEntryModal(ticket, index);
        });
        tdEntrance.appendChild(entranceBtn);
        tr.appendChild(tdEntrance);

        purchasedTicketsTbody.appendChild(tr);
      });
    }

    function showEntryModal(ticket, ticketIndex) {
      const entranceModalBody = document.getElementById('entrance-modal-body');
      const entranceModalFooter = document.getElementById('entrance-modal-footer');
      entranceModalBody.innerHTML = '';
      entranceModalFooter.innerHTML = '';

      const imgWrapper = document.createElement('div');
      imgWrapper.className = 'd-flex justify-content-center';

      const img = document.createElement('img');
      img.src = ticket.qr_code_url;
      img.alt = 'Entry QR Code';
      img.style.maxWidth = '100%';
      imgWrapper.appendChild(img);
      entranceModalBody.appendChild(imgWrapper);

      const errorMsg = document.createElement('div');
      errorMsg.className = 'text-danger mt-2';
      entranceModalBody.appendChild(errorMsg);

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-secondary';
      cancelBtn.textContent = 'キャンセル';
      cancelBtn.setAttribute('data-bs-dismiss','modal');

      const enterBtn = document.createElement('button');
      enterBtn.className = 'btn btn-primary';
      enterBtn.textContent = '入場する';
      enterBtn.addEventListener('click', async () => {
        const enterRes = await fetch('/api/entry', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ entry_token: ticket.entry_token })
        }).then(r=>r.json());

        if (enterRes.status === 'success') {
          ticket.is_entered = true;
          renderPurchasedTickets();
          entranceModal.hide();
        } else if (enterRes.status === 'TRAIN_DEPARTED') {
          entranceModal.hide();
          // 続けてモーダルを表示できるように前のモーダルが消えたのを確認してから表示
          const handler = () => {
            entranceModal._element.removeEventListener('hidden.bs.modal', handler);
            showRefundModal(ticket, ticketIndex, "列車の出発時間をすでに過ぎております。返金しますか？");
          };
          entranceModal._element.addEventListener('hidden.bs.modal', handler);
        } else {
          errorMsg.textContent = '入場に失敗しました。後ほどお試しください。';
        }
      });

      entranceModalFooter.appendChild(cancelBtn);
      entranceModalFooter.appendChild(enterBtn);

      entranceModal.show();
    }

    // 入場処理でエラーになった場合にも使うrefundモーダル表示関数
    function showRefundModal(ticket, ticketIndex, message) {
      const entranceModalBody = document.getElementById('entrance-modal-body');
      const entranceModalFooter = document.getElementById('entrance-modal-footer');
      if(!entranceModalBody || !entranceModalFooter)return;

      entranceModalBody.innerHTML = `<p>${message}</p>`;
      entranceModalFooter.innerHTML = '';

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-secondary';
      cancelBtn.textContent = 'キャンセル';
      cancelBtn.setAttribute('data-bs-dismiss','modal');

      const refundBtn = document.createElement('button');
      refundBtn.className = 'btn btn-primary';
      refundBtn.textContent = '返金';
      refundBtn.addEventListener('click', async () => {
        const res = await fetch('/api/refund', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ reservation_id: ticket.reservation_id })
        });
        if(res.ok) {
          // 返金成功後チケット削除
          purchasedTickets.splice(ticketIndex, 1);
          renderPurchasedTickets();
          entranceModal.hide();
        } else {
          // 返金失敗時の処理(必要なら)
          console.error('返金失敗');
        }
      });

      entranceModalFooter.appendChild(cancelBtn);
      entranceModalFooter.appendChild(refundBtn);

      entranceModal.show();
    }

    function showInitializeButton() {
      initializeButtonContainer.innerHTML = '';
      const btn = document.createElement('button');
      btn.className = 'btn btn-warning btn-sm';
      btn.textContent = '初期化';
      btn.addEventListener('click', async () => {
        await fetch('/api/initialize', {method: 'POST'});
        location.reload();
      });
      initializeButtonContainer.appendChild(btn);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const logoutButton = document.getElementById('logout-button');
      logoutButton?.addEventListener('click', async () => {
        const res = await fetch('/api/logout', {
          method: 'POST'
        });
        if (res.ok) {
          // ログアウト成功時にログインページへ遷移
          location.href = '/login.html';
        } else {
          console.error('ログアウトに失敗しました');
          // 必要であればエラー表示など
        }
      });
    });

    function updateCurrentTimeDisplay() {
      const hh = String(currentHours).padStart(2,'0');
      const mm = String(currentMinutes).padStart(2,'0');
      currentTimeDisplay.textContent = `${hh}:${mm}`;
    }

    function incrementTimeByOneMinute() {
      if (currentHours === 24 && currentMinutes === 0) {
        clearInterval(clockInterval);
        clockInterval = null;
        showInitializeButton();
        return;
      }

      currentMinutes += 1;
      if (currentMinutes >= 60) {
        currentMinutes = 0;
        currentHours += 1;
        if (currentHours > 24) {
          currentHours = 24;
          currentMinutes = 0;
        }
      }

      updateCurrentTimeDisplay();
    }

    async function checkSession() {
      try {
        const res = await fetch('/api/session');
        if (!res.ok) {
          console.error('セッションチェックのリクエストに失敗しました');
          return;
        }
        const data = await res.json();
        if (data.status === 'session_expired') {
          location.href = '/login.html';
        } else if (data.status === 'active') {
          setTimeout(checkSession, data.next_check);
        } else {
          console.error('未知のステータス: ', data.status);
        }
      } catch (err) {
        console.error('セッションチェックエラー: ', err);
      }
    }

    function startClockSimulation() {
      clockInterval = setInterval(incrementTimeByOneMinute, 100);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
