<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新幹線チケット予約 - Ishokansen Reservation</title>
  <!-- Bootstrap v5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body class="bg-light">
  <!-- ヘッダー (ナビゲーションバー) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <!-- ブランド部分 -->
      <a class="navbar-brand d-flex align-items-center" href="#">
        <span class="fs-5 fw-bold">Ishokansen Reservation</span>
        <span class="ms-2 text-white-50" style="font-size: 0.9rem;">新幹線チケット予約</span>
      </a>
      <div class="d-flex ms-auto align-items-center">
        <!-- 現在時刻表示用 -->
        <span id="current-time-display" class="text-white me-3">--:--</span>
        <!-- 初期化ボタン表示場所 -->
        <span id="initialize-button-container" class="me-3"></span>
        <!-- ユーザ名表示 -->
        <span class="text-white me-3">Taro</span>
        <!-- ログアウトボタン追加 -->
        <button id="logout-button" class="btn btn-outline-light btn-sm me-3">ログアウト</button>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <section id="reservation-section" class="mb-5">
      <h2 class="mb-3">予約フォーム</h2>
      <form id="reservation-form" class="row g-3">
        <div class="col-md-3">
          <label for="train-select" class="form-label">電車</label>
          <select id="train-select" class="form-select"></select>
        </div>
        <div class="col-md-3">
          <label for="from-station-select" class="form-label">乗車駅</label>
          <select id="from-station-select" class="form-select"></select>
        </div>
        <div class="col-md-3">
          <label for="to-station-select" class="form-label">降車駅</label>
          <select id="to-station-select" class="form-select"></select>
        </div>
        <div class="col-md-2">
          <label for="num-people" class="form-label">人数</label>
          <input type="number" id="num-people" class="form-control" min="1" value="1"/>
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <button type="button" id="reserve-button" class="btn btn-primary w-100">予約</button>
        </div>
      </form>
    </section>

    <section id="train-list-section" class="mb-5">
      <h2 class="mb-3">直近発車の電車一覧</h2>
      <table id="train-list-table" class="table table-striped table-bordered table-responsive mb-4">
        <thead class="table-light">
          <tr>
            <th rowspan="2" class="align-middle">電車名</th>
            <th colspan="4" class="text-center">往路</th>
            <th colspan="4" class="text-center">復路</th>
          </tr>
          <tr>
            <th>A <i class="bi bi-arrow-right"></i> B</th>
            <th>B <i class="bi bi-arrow-right"></i> C</th>
            <th>C <i class="bi bi-arrow-right"></i> D</th>
            <th>D <i class="bi bi-arrow-right"></i> E</th>
            <th>E <i class="bi bi-arrow-right"></i> D</th>
            <th>D <i class="bi bi-arrow-right"></i> C</th>
            <th>C <i class="bi bi-arrow-right"></i> B</th>
            <th>B <i class="bi bi-arrow-right"></i> A</th>
          </tr>
        </thead>
        <tbody id="train-list-tbody">
        </tbody>
      </table>
    </section>

    <section id="purchased-tickets-section">
      <h2 class="mb-3">購入済チケット一覧</h2>
      <table id="purchased-tickets-table" class="table table-striped table-bordered table-responsive">
        <thead class="table-light">
          <tr>
            <th>電車名</th>
            <th>乗車駅</th>
            <th>降車駅</th>
            <th>出発時間</th>
            <th>人数</th>
            <th>金額</th>
            <th>入場済み</th>
            <th>返金</th>
            <th>入場</th>
          </tr>
        </thead>
        <tbody id="purchased-tickets-tbody">
        </tbody>
      </table>
    </section>
  </div>

  <!-- 予約結果モーダル -->
  <div class="modal fade" id="reservation-modal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reservationModalLabel">予約結果</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body" id="reservation-modal-body"></div>
        <div class="modal-footer" id="reservation-modal-footer"></div>
      </div>
    </div>
  </div>

  <!-- 入場モーダル -->
  <div class="modal fade" id="entrance-modal" tabindex="-1" aria-labelledby="entranceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="entranceModalLabel">入場確認</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body" id="entrance-modal-body"></div>
        <div class="modal-footer" id="entrance-modal-footer"></div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const messages = {
      success: "以下の座席を確保しました:",
      recommend: "指定の条件では席が確保できませんでした。代わりにこちらはいかがですか？",
      fail: {
        NO_SEAT_AVAILABLE: "指定の条件に当てはまるチケットはご用意できませんでした"
      }
    };

    async function fetchTrains() {
      const res = await fetch('/api/trains');
      const data = await res.json();
      return data.trains;
    }

    async function fetchStations() {
      const res = await fetch('/api/stations');
      const data = await res.json();
      return data.stations;
    }

    async function fetchCurrentTime() {
      const res = await fetch('/api/current_time');
      const data = await res.json();
      return data.current_time;
    }

    async function fetchPurchasedTickets() {
      // APIで購入済みチケット一覧取得
      // 例: [{"train_name":"...","from_station":"...","to_station":"...","departure_time":"...","num_people":2,"total_price":20000,"entered":false,"entry_token":"...","qr_code_url":"..."}]
      const res = await fetch('/api/purchased_tickets');
      const data = await res.json();
      return data.tickets;
    }

    let trains = [];
    let stations = [];
    let currentHours = 0;
    let currentMinutes = 0;
    let clockInterval = null;
    let purchasedTickets = [];

    const trainSelect = document.getElementById('train-select');
    const fromStationSelect = document.getElementById('from-station-select');
    const toStationSelect = document.getElementById('to-station-select');
    const trainListTbody = document.getElementById('train-list-tbody');
    const reserveButton = document.getElementById('reserve-button');
    const numPeopleInput = document.getElementById('num-people');
    const currentTimeDisplay = document.getElementById('current-time-display');
    const purchasedTicketsTbody = document.getElementById('purchased-tickets-tbody');
    const reservationModal = new bootstrap.Modal(document.getElementById('reservation-modal'), {});
    const entranceModal = new bootstrap.Modal(document.getElementById('entrance-modal'), {});
    const initializeButtonContainer = document.getElementById('initialize-button-container');

    const segmentMap = [
      { key: 'Arena->Bridge', from: 'A', to: 'B' },
      { key: 'Bridge->Cave', from: 'B', to: 'C' },
      { key: 'Cave->Dock', from: 'C', to: 'D' },
      { key: 'Dock->Edge', from: 'D', to: 'E' },
      { key: 'Edge->Dock', from: 'E', to: 'D' },
      { key: 'Dock->Cave', from: 'D', to: 'C' },
      { key: 'Cave->Bridge', from: 'C', to: 'B' },
      { key: 'Bridge->Arena', from: 'B', to: 'A' }
    ];

    const availabilityIcons = {
      none: '✗',
      few: '△',
      lots: '◯'
    };

    async function init() {
      const [fetchedTrains, fetchedStations, fetchedCurrentTime, fetchedTickets] = await Promise.all([
        fetchTrains(), fetchStations(), fetchCurrentTime(), fetchPurchasedTickets()
      ]);

      trains = fetchedTrains;
      stations = fetchedStations;
      purchasedTickets = fetchedTickets; // APIから取得した購入済みチケットをセット

      const [h, m] = fetchedCurrentTime.split(':').map(v => parseInt(v,10));
      currentHours = h;
      currentMinutes = m;

      renderTrainList(trains);
      renderTrainOptions(trains);
      renderStationOptions(stations, fromStationSelect);
      renderStationOptions(stations, toStationSelect);

      renderPurchasedTickets();

      updateCurrentTimeDisplay();
      startClockSimulation();
    }

    function renderTrainList(trainData) {
      trainListTbody.innerHTML = '';
      trainData.forEach(t => {
        const tr = document.createElement('tr');
        const tdName = document.createElement('td');
        tdName.textContent = t.name;
        tr.appendChild(tdName);

        segmentMap.forEach(seg => {
          const td = document.createElement('td');
          const status = t.availability[seg.key] || 'none';
          const icon = availabilityIcons[status] || '✗';

          const departure = t.departure_times && t.departure_times[seg.key] ? t.departure_times[seg.key] : '--:--';
          td.textContent = `${icon} (${departure})`;
          tr.appendChild(td);
        });

        trainListTbody.appendChild(tr);
      });
    }

    function renderTrainOptions(trainData) {
      trainSelect.innerHTML = '';
      trainData.forEach(t => {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = t.name;
        trainSelect.appendChild(option);
      });
    }

    function renderStationOptions(stationData, selectEl) {
      selectEl.innerHTML = '';
      stationData.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = s.name;
        selectEl.appendChild(option);
      });
    }

    reserveButton.addEventListener('click', async () => {
      const selectedTrainId = trainSelect.value;
      const fromStationId = fromStationSelect.value;
      const toStationId = toStationSelect.value;
      const numPeople = parseInt(numPeopleInput.value, 10);

      const res = await fetch('/api/reserve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          train_id: selectedTrainId,
          from_station_id: fromStationId,
          to_station_id: toStationId,
          num_people: numPeople
        })
      }).then(r=>r.json());

      handleReservationResponse(res);
    });

    function handleReservationResponse(res) {
      const modalBody = document.getElementById('reservation-modal-body');
      const modalFooter = document.getElementById('reservation-modal-footer');
      modalBody.innerHTML = '';
      modalFooter.innerHTML = '';

      if (res.status === 'success' || res.status === 'recommend') {
        const info = res.status === 'success' ? res.reserved : res.recommend;

        modalBody.innerHTML = `
          <p>${res.status === 'success' ? messages.success : messages.recommend}</p>
          <p>電車名: ${info.train_name}</p>
          <p>区間: ${info.from_station} -> ${info.to_station}</p>
          <p>出発時間: ${info.departure_time}</p>
          <p>座席: ${info.seats.join(', ')}</p>
          <p>合計金額: ${info.total_price}円</p>
        `;
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-secondary';
        cancelBtn.textContent = 'キャンセル';
        cancelBtn.setAttribute('data-bs-dismiss','modal');

        const purchaseBtn = document.createElement('button');
        purchaseBtn.className = 'btn btn-primary';
        purchaseBtn.textContent = '購入';
        purchaseBtn.addEventListener('click', async () => {
          await purchaseTicketAPI(info);
          reservationModal.hide();
        });

        modalFooter.appendChild(cancelBtn);
        modalFooter.appendChild(purchaseBtn);

      } else {
        // fail
        const ec = res.error_code || 'UNKNOWN';
        const msg = messages.fail[ec] || 'エラーが発生しました';
        modalBody.innerHTML = `<p>${msg}</p>`;
        const okBtn = document.createElement('button');
        okBtn.className = 'btn btn-primary';
        okBtn.textContent = 'OK';
        okBtn.setAttribute('data-bs-dismiss','modal');
        modalFooter.appendChild(okBtn);
      }

      reservationModal.show();
    }

    async function purchaseTicketAPI(info) {
      // infoには reservation_id が入っている前提
      const purchaseRes = await fetch('/api/purchase', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          reservation_id: info.reservation_id
        })
      }).then(r=>r.json());

      if (purchaseRes.status === 'success') {
        // /api/purchaseからは情報返らない前提なのでinfoをそのまま使用
        purchasedTickets.push({
          train_name: info.train_name,
          from_station: info.from_station,
          to_station: info.to_station,
          departure_time: info.departure_time,
          num_people: info.seats.length,
          total_price: info.total_price,
          entered: false,
          entry_token: info.entry_token,
          qr_code_url: info.qr_code_url
        });
        renderPurchasedTickets();
      } else {
        console.error('購入処理でエラー:', purchaseRes);
      }
    }

    function renderPurchasedTickets() {
      purchasedTicketsTbody.innerHTML = '';
      purchasedTickets.forEach((ticket, index) => {
        const tr = document.createElement('tr');

        const tdTrain = document.createElement('td');
        tdTrain.textContent = ticket.train_name;
        tr.appendChild(tdTrain);

        const tdFrom = document.createElement('td');
        tdFrom.textContent = ticket.from_station;
        tr.appendChild(tdFrom);

        const tdTo = document.createElement('td');
        tdTo.textContent = ticket.to_station;
        tr.appendChild(tdTo);

        const tdDeparture = document.createElement('td');
        tdDeparture.textContent = ticket.departure_time;
        tr.appendChild(tdDeparture);

        const tdNum = document.createElement('td');
        tdNum.textContent = String(ticket.num_people);
        tr.appendChild(tdNum);

        const tdPrice = document.createElement('td');
        tdPrice.textContent = String(ticket.total_price);
        tr.appendChild(tdPrice);

        const tdEntered = document.createElement('td');
        const enteredCheckbox = document.createElement('input');
        enteredCheckbox.type = 'checkbox';
        enteredCheckbox.checked = ticket.entered;
        enteredCheckbox.disabled = true;
        tdEntered.appendChild(enteredCheckbox);
        tr.appendChild(tdEntered);

        const tdRefund = document.createElement('td');
        const refundBtn = document.createElement('button');
        refundBtn.className = 'btn btn-danger btn-sm';
        refundBtn.textContent = '返金';
        refundBtn.addEventListener('click', () => {
          console.log(`返金ボタンが押されました: ${ticket.train_name}`);
          // 返金処理(API)が成功したら削除など
          purchasedTickets.splice(index,1);
          renderPurchasedTickets();
        });
        tdRefund.appendChild(refundBtn);
        tr.appendChild(tdRefund);

        const tdEntrance = document.createElement('td');
        const entranceBtn = document.createElement('button');
        entranceBtn.className = 'btn btn-success btn-sm';
        entranceBtn.textContent = '入場';
        entranceBtn.disabled = ticket.entered;
        entranceBtn.addEventListener('click', () => {
          showEntryModal(ticket, index);
        });
        tdEntrance.appendChild(entranceBtn);
        tr.appendChild(tdEntrance);

        purchasedTicketsTbody.appendChild(tr);
      });
    }

    function showEntryModal(ticket, index) {
      const entranceModalBody = document.getElementById('entrance-modal-body');
      const entranceModalFooter = document.getElementById('entrance-modal-footer');
      entranceModalBody.innerHTML = '';
      entranceModalFooter.innerHTML = '';

      const img = document.createElement('img');
      img.src = ticket.qr_code_url;
      img.alt = 'Entry QR Code';
      img.style.maxWidth = '100%';
      entranceModalBody.appendChild(img);

      const errorMsg = document.createElement('div');
      errorMsg.className = 'text-danger mt-2';
      entranceModalBody.appendChild(errorMsg);

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-secondary';
      cancelBtn.textContent = 'キャンセル';
      cancelBtn.setAttribute('data-bs-dismiss','modal');

      const enterBtn = document.createElement('button');
      enterBtn.className = 'btn btn-primary';
      enterBtn.textContent = '入場する';
      enterBtn.addEventListener('click', async () => {
        const enterRes = await fetch('/api/entry', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ entry_token: ticket.entry_token })
        }).then(r=>r.json());

        if (enterRes.status === 'success') {
          ticket.entered = true;
          renderPurchasedTickets();
          entranceModal.hide();
        } else {
          if (enterRes.error_code === 'TRAIN_DEPARTED') {
            errorMsg.textContent = '出発時間を過ぎています。入場できません。';
          } else {
            errorMsg.textContent = '入場に失敗しました。後ほどお試しください。';
          }
        }
      });

      entranceModalFooter.appendChild(cancelBtn);
      entranceModalFooter.appendChild(enterBtn);

      entranceModal.show();
    }

    function showInitializeButton() {
      initializeButtonContainer.innerHTML = '';
      const btn = document.createElement('button');
      btn.className = 'btn btn-warning btn-sm';
      btn.textContent = '初期化';
      btn.addEventListener('click', async () => {
        await fetch('/api/initialize', {method: 'POST'});
        location.reload();
      });
      initializeButtonContainer.appendChild(btn);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const logoutButton = document.getElementById('logout-button');
      logoutButton?.addEventListener('click', async () => {
        const res = await fetch('/api/logout', {
          method: 'POST'
        });
        if (res.ok) {
          // ログアウト成功時にログインページへ遷移
          location.href = '/login.html';
        } else {
          console.error('ログアウトに失敗しました');
          // 必要であればエラー表示など
        }
      });
    });

    function updateCurrentTimeDisplay() {
      const hh = String(currentHours).padStart(2,'0');
      const mm = String(currentMinutes).padStart(2,'0');
      currentTimeDisplay.textContent = `${hh}:${mm}`;
    }

    function incrementTimeByOneMinute() {
      if (currentHours === 24 && currentMinutes === 0) {
        clearInterval(clockInterval);
        clockInterval = null;
        showInitializeButton();
        return;
      }

      currentMinutes += 1;
      if (currentMinutes >= 60) {
        currentMinutes = 0;
        currentHours += 1;
        if (currentHours > 24) {
          currentHours = 24;
          currentMinutes = 0;
        }
      }

      updateCurrentTimeDisplay();
    }

    function startClockSimulation() {
      clockInterval = setInterval(incrementTimeByOneMinute, 100);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
